

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>P3DFFT User Guide &mdash; P3DFFT 3.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Installing P3DFFT++" href="install_p3dfft++.html" />
    <link rel="prev" title="Download P3DFFT" href="download_p3dfft.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #db4c3f" >
          

          
            <a href="index.html" class="icon icon-home"> P3DFFT
          

          
          </a>

          
            
            
              <div class="version">
                3.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="home.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="install_p3dfft.html">Install P3DFFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="download_p3dfft.html">Download P3DFFT</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">P3DFFT Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#acknowledgements">Acknowledgements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#directory-structure-and-files">1. Directory Structure and Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installing-p3dfft">2. Installing p3dfft</a></li>
<li class="toctree-l2"><a class="reference internal" href="#p3dfft-module">3. p3dfft module</a></li>
<li class="toctree-l2"><a class="reference internal" href="#initialization">4. Initialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#array-decomposition">5. Array Decomposition</a></li>
<li class="toctree-l2"><a class="reference internal" href="#forward-real-to-complex-and-backward-complex-to-real-3d-fourier-transforms">6. Forward (real-to-complex) and backward (complex-to-real) 3D Fourier transforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="#complex-array-storage-definition">7. Complex array storage definition</a></li>
<li class="toctree-l2"><a class="reference internal" href="#multivariable-transforms">8. Multivariable transforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pruned-transforms">9. Pruned transforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="#in-place-transforms">10. In-place transforms</a></li>
<li class="toctree-l2"><a class="reference internal" href="#memory-requirements">11. Memory requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="#performance-considerations">12. Performance considerations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#references">13. References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="install_p3dfft++.html">Install P3DFFT++</a></li>
<li class="toctree-l1"><a class="reference internal" href="download_p3dfft++.html">Download P3DFFT++</a></li>
<li class="toctree-l1"><a class="reference internal" href="p3dfft++_documentation.html">P3DFFT++ Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="contact.html">Contact</a></li>
<li class="toctree-l1"><a class="reference internal" href="license_of_use.html">License of use</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">P3DFFT</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>P3DFFT User Guide</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/p3dfft_documentation.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="p3dfft-user-guide">
<span id="p3dfft-documentation"></span><h1>P3DFFT User Guide<a class="headerlink" href="#p3dfft-user-guide" title="Permalink to this headline">¶</a></h1>
<p>Version 2.7.5</p>
<p>Copyright (C) 2006-2019 Dmitry Pekurovsky Copyright (C) 2006-2019 University of California</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.</p>
<p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.</p>
<p class="last">You should have received a copy of the GNU General Public License along with this program. If not, see <a class="reference external" href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a></p>
</div>
<div class="section" id="acknowledgements">
<h2>Acknowledgements<a class="headerlink" href="#acknowledgements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Prof. P.K.Yeung</li>
<li>Dr. Diego Donzis</li>
<li>Dr. Giri Chukkapalli</li>
<li>Dr. Geert Brethouwer</li>
</ul>
<p><strong>Citation</strong>: when reporting results obtained with P3DFFT, please cite the following:</p>
<p>D. Pekurovsky, “P3DFFT: a framework for parallel computations of Fourier transforms in three dimensions”, <strong>SIAM Journal on Scientific Computing</strong> 2012, Vol. 34, No. 4, pp. C192-C209.</p>
</div>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>P3DFFT is a scalable software library implementing three-dimensional spectral transforms. It has been used in a variety of codes from many areas of computational science. It has been tested and used on many high-end computational system. It uses two-dimensional domain decomposition in order to overcome a scaling bottleneck of one-dimensional decomposition. This allows the programs with this library to scale well on a large number of cores, consistent with bisection bandwidth scaling of interconnect of the underlying hardware system.</p>
<p>Below are the main features of P3DFFT v. 2.7.5:</p>
<ul class="simple">
<li>Real-to-complex and complex-to-real Fast Fourier Transforms (FFT) in 3D.</li>
<li>Cosine, sine, and combined Fourier-Chebyshev transform (FFT in 2D and Chebyshev in the third dimension). Alternatively users can substitute their own transform in the third dimension, for example a compact scheme.</li>
<li>Fortran and C interfaces</li>
<li>Built for performance at all ranges of core counts</li>
<li>Hybrid MPI/OpenMP implementation</li>
<li>In-place and out-of-place transforms</li>
<li>Pruned transforms</li>
<li>Multivariable transforms</li>
</ul>
</div>
<div class="section" id="directory-structure-and-files">
<h2>1. Directory Structure and Files<a class="headerlink" href="#directory-structure-and-files" title="Permalink to this headline">¶</a></h2>
<p>The following is a directory listing for what you should find in the <code class="docutils literal notranslate"><span class="pre">p3dfft</span></code> package:</p>
<p><strong>Table 1</strong>: Directory structure of <code class="docutils literal notranslate"><span class="pre">p3dfft</span></code> package</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">Directory</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><em>toplevel</em></td>
<td>The <code class="docutils literal notranslate"><span class="pre">configure</span></code> script is located here. Running the <code class="docutils literal notranslate"><span class="pre">configure</span></code> script is essential for properly building P3DFFT. Please refer to section 2 of this guide for more information.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">build/</span></code></td>
<td>The library files are contained here. Building the library is required before it can be used. In order to build the library, you must run <code class="docutils literal notranslate"><span class="pre">./configure</span></code> from the top level directory. Then type <code class="docutils literal notranslate"><span class="pre">make</span></code> and then <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code>. For further details on building the library see section 2 of this guide.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">include/</span></code></td>
<td>The library is provided as a Fortran module. After installation this directory will have <code class="docutils literal notranslate"><span class="pre">p3dfft.mod</span></code> (for Fortran interface), <code class="docutils literal notranslate"><span class="pre">p3dfft.h</span></code> (C wrapper/include file), and <code class="docutils literal notranslate"><span class="pre">config.h</span></code> (header that contains all arguments used when configure script was executed).</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">sample/</span></code></td>
<td>This directory has example programs in both FORTRAN and C, in separate subdirectories. Tests provided include out-of-place and in-place transforms 3D FFT, with error checking. Also provided is an example of power spectrum calculation. Example programs will be compiled automatically with the library during make.</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">In order to use P3DFFT with C programs, you must include the <code class="docutils literal notranslate"><span class="pre">p3dfft.h</span></code> header file in your program. This header file defines an interface that allows C programs to call Fortran functions from the P3DFFT library.</p>
</div>
<p>In addition to the library itself, the package includes several sample programs to illustrate how to use P3DFFT. These sample programs can be found in the <code class="docutils literal notranslate"><span class="pre">sample/</span></code> directory:</p>
<p><strong>Table 2</strong>: Filename and description of samples</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">Source filename</th>
<th class="head">Binary filename</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">driver_inverse.c</span></code>, <code class="docutils literal notranslate"><span class="pre">driver_inverse.F90</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">test_inverse_c.x</span></code>, <code class="docutils literal notranslate"><span class="pre">test_inverse_f.x</span></code></td>
<td>This program initializes a 3D array of complex numbers with a 3D sine/cosine wave, then performs inverse FFT transform, and checks that the results are correct. This sample program also demonstrates how to work with complex arrays in wavenumber space, declared as real.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">driver_rand.c</span></code>, <code class="docutils literal notranslate"><span class="pre">driver_rand.F90</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">test_rand_c.x</span></code>, <code class="docutils literal notranslate"><span class="pre">test_rand_f.x</span></code></td>
<td>This program initializes a 3D array with random numbers, then performs forward 3D Fourier transform, then backward transform, and checks that the results are correct, namely the same as in the start except for a normalization factor. It can be used both as a correctness test and for timing the library functions.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">driver_sine.c</span></code>, <code class="docutils literal notranslate"><span class="pre">driver_sine_inplace.c</span></code>, <code class="docutils literal notranslate"><span class="pre">driver_sine.F90</span></code>, <code class="docutils literal notranslate"><span class="pre">driver_sine_ineplace.F90</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">test_sine_c.x</span></code>, <code class="docutils literal notranslate"><span class="pre">test_sine_inplace_c.x</span></code>, <code class="docutils literal notranslate"><span class="pre">test_sine_f.x</span></code>, <code class="docutils literal notranslate"><span class="pre">test_sine_inplace_f.x</span></code></td>
<td>This program initializes a 3D array with a 3D sine wave, then performs 3D forward Fourier transform, then backward transform, and checks that the results are correct, namely the same as in the start except for a normalization factor. It can be used both as a correctness test and for timing the library functions.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">driver_sine_many.F90</span></code>, <code class="docutils literal notranslate"><span class="pre">driver_sine_inplace_many.F90</span></code>, <code class="docutils literal notranslate"><span class="pre">driver_rand_many.F90</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">test_sine_many_f.x</span></code>, <code class="docutils literal notranslate"><span class="pre">test_sine_inplace_many_f.x</span></code>, <code class="docutils literal notranslate"><span class="pre">test_rand_many_f.x</span></code></td>
<td>Same as above, but these program tests the multivariable transform feature. There is an extra parameter in the input file specifying the number of variables to transform (<code class="docutils literal notranslate"><span class="pre">nv</span></code>).</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">driver_spec.c</span></code>, <code class="docutils literal notranslate"><span class="pre">driver_spec.F90</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">test_spec_c.x</span></code>, <code class="docutils literal notranslate"><span class="pre">test_spec_f.x</span></code></td>
<td>This program initializes a 3D array with a 3D sine wave, then performs 3D FFT forward transform, and computes power spectrum.</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">driver_cheby.f90</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">test_cheby_f.x</span></code></td>
<td>This program initializes a 3D array with a sine wave, employing a non-uniform grid in the Z dimension with coordinates given by cos(k/N). Then Chebyshev routine is called (<code class="docutils literal notranslate"><span class="pre">p3dfft_cheby</span></code>) which uses Fourier transform in X and Y and a cosine transform in Z (&quot;ffc&quot;), followed by computation of Chebyshev coefficients. Then backward &quot;cff&quot; transform is called and the results are compared with the expected output after Chebyshev differentiation in Z. This program can be used both as correctness and as a timing test.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">driver_noop.c</span></code>, <code class="docutils literal notranslate"><span class="pre">driver_noop.F90</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">test_noop_c.x</span></code>, <code class="docutils literal notranslate"><span class="pre">test_noop_f.x</span></code></td>
<td>Similar to the above but instead of Chebyshev transform nothing is done; i.e. only 2D FFT is performed and then the data is laid out in a format suitable for a custom transform of the user’s choice in the third dimension (i.e. data is local for each processor in that dimension).</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="installing-p3dfft">
<h2>2. Installing p3dfft<a class="headerlink" href="#installing-p3dfft" title="Permalink to this headline">¶</a></h2>
<p>In order to prepare the P3DFFT for compiling and installation, you must run the included <code class="docutils literal notranslate"><span class="pre">configure</span></code> script. Here is a simple example on how to run the <code class="docutils literal notranslate"><span class="pre">configure</span></code> script:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ./configure --enable-pgi --enable-fftw --with-fftw<span class="o">=</span>/usr/local/fftw/ <span class="nv">LDFLAGS</span><span class="o">=</span><span class="s2">&quot;-lmpi_f90 –lmpi_f77&quot;</span>
</pre></div>
</div>
<p>The above will prepare P3DFFT to be compiled by the PGI compiler with FFTW support. There are more arguments included in the <code class="docutils literal notranslate"><span class="pre">configure</span></code> script that will allow you to customize P3DFFT to your requirements:</p>
<p><strong>Table 3</strong>: Arguments of <code class="docutils literal notranslate"><span class="pre">configure</span></code> script</p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">Argument</th>
<th class="head">Notes</th>
<th class="head">Description</th>
<th class="head">Example</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">--prefix=PREFIX</span></code></td>
<td>Mandatory for users without access to <code class="docutils literal notranslate"><span class="pre">/usr/local</span></code></td>
<td>This argument will install P3DFFT to <code class="docutils literal notranslate"><span class="pre">PREFIX</span></code> when you run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code>. By default, configure will install to <code class="docutils literal notranslate"><span class="pre">/usr/local</span></code>.</td>
<td><code class="docutils literal notranslate"><span class="pre">--prefix=$HOME/local/</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">--enable-gnu</span></code>, <code class="docutils literal notranslate"><span class="pre">--enable-ibm</span></code>, <code class="docutils literal notranslate"><span class="pre">--enable-intel</span></code>, <code class="docutils literal notranslate"><span class="pre">--enable-pgi</span></code>, <code class="docutils literal notranslate"><span class="pre">--enable-cray</span></code></td>
<td>Mandatory</td>
<td>These arguments will prepare P3DFFT to be built by a specific compiler. You must only choose one option.</td>
<td><code class="docutils literal notranslate"><span class="pre">--enable-pgi</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">--enable-fftw</span></code>, <code class="docutils literal notranslate"><span class="pre">--enable-essl</span></code></td>
<td>Mandatory</td>
<td>These arguments will prepare P3DFFT to be used with either the FFTW or ESSL library. You must only choose one option.</td>
<td><code class="docutils literal notranslate"><span class="pre">--enable-fftw</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">--with-fftw=FFTWLOCATION</span></code></td>
<td>Mandatory if <code class="docutils literal notranslate"><span class="pre">--enable-fftw</span></code> is used</td>
<td>This argument specifies the path location for the FFTW library; it is mandatory if you are planning to use P3DFFT with the FFTW library.</td>
<td><code class="docutils literal notranslate"><span class="pre">--with-fftw=$FFTW_HOME</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">--enable-openmp</span></code></td>
<td>Mandatory if using multithreaded version</td>
<td>This argument adds the appropriate compiler flags to enable OpenMP.</td>
<td><code class="docutils literal notranslate"><span class="pre">--enable-openmp</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">--enable-openmpi</span></code></td>
<td>Optional</td>
<td>This argument uses the OpenMPI implementation of MPI.</td>
<td><code class="docutils literal notranslate"><span class="pre">--enable-openmpi</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">--enable-oned</span></code></td>
<td>Optional</td>
<td>This argument is for 1D decomposition. The default is 2D decomposition but can be made to 1D by setting up a grid 1xN when running the code.</td>
<td><code class="docutils literal notranslate"><span class="pre">--enable-oned</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">--enable-estimate</span></code></td>
<td>Optional, use only with <code class="docutils literal notranslate"><span class="pre">--enable-fftw</span></code></td>
<td>If this argument is passed, the FFTW library will not use run-time tuning to select the fastest algorithm for computing FFTs.</td>
<td><code class="docutils literal notranslate"><span class="pre">--enable-estimate</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">--enable-measure</span></code></td>
<td>Optional, enabled by default, use only with <code class="docutils literal notranslate"><span class="pre">--enable-fftw</span></code></td>
<td>For search-once-for-the-fast algorithm (takes more time on <code class="docutils literal notranslate"><span class="pre">p3dfft_setup()</span></code>).</td>
<td><code class="docutils literal notranslate"><span class="pre">--enable-measure</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">--enable-patient</span></code></td>
<td>Optional, use only with <code class="docutils literal notranslate"><span class="pre">--enable-fftw</span></code></td>
<td>For search-once-for-the-fastest-algorithm (takes much more time on <code class="docutils literal notranslate"><span class="pre">p3dfft_setup()</span></code>).</td>
<td><code class="docutils literal notranslate"><span class="pre">--enable-patient</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">--enable-dimsc</span></code></td>
<td>Optional</td>
<td>To assign processor rows and columns in the Cartesian processor grid according to C convention. The default is Fortran convention which is recommended. This option does not affect the order of storage of arrays in memory.</td>
<td><code class="docutils literal notranslate"><span class="pre">--enable-dimsc</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">--enable-useeven</span></code></td>
<td>Optional, recommended for Cray XT</td>
<td>This argument is for using <code class="docutils literal notranslate"><span class="pre">MPI_Alltoall</span></code> instead of <code class="docutils literal notranslate"><span class="pre">MPI_Alltotallv</span></code>. This will pad the send buffers with zeros to make them of equal size; not needed on most architecture but may lead to better results on Cray XT.</td>
<td><code class="docutils literal notranslate"><span class="pre">--enable-useeven</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">--enable-stride1</span></code></td>
<td>Optional, recommended</td>
<td>To enable stride-1 data structures on output (this may in some cases give some advantage in performance). You can define loop blocking factors <code class="docutils literal notranslate"><span class="pre">NLBX</span></code> and <code class="docutils literal notranslate"><span class="pre">NBLY</span></code> to experiment, otherwise they are set to default values.</td>
<td><code class="docutils literal notranslate"><span class="pre">--enable-stride1</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">--enable-nblx</span></code></td>
<td>Optional</td>
<td>To define loop blocking factor <code class="docutils literal notranslate"><span class="pre">NBL_X</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">--enable-nblx=32</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">--enable-nbly1</span></code></td>
<td>Optional</td>
<td>To define loop blocking factor <code class="docutils literal notranslate"><span class="pre">NBL_Y1</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">--enable-nbly1=32</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">--enable-nbly2</span></code></td>
<td>Optional</td>
<td>To define loop blocking factor <code class="docutils literal notranslate"><span class="pre">NBL_Y2</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">--enable-nbly2=32</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">--enable-nblz</span></code></td>
<td>Optional</td>
<td>To define loop blocking factor <code class="docutils literal notranslate"><span class="pre">NBL_Z</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">--enable-nblz=32</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">--enable-single</span></code></td>
<td>Optional</td>
<td>This argument will compile P3DFFT in single-precision. By default, configure will setup P3DFFT to be compiled in double-precision.</td>
<td><code class="docutils literal notranslate"><span class="pre">--enable-single</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">FC=&lt;Fortran</span> <span class="pre">compiler&gt;</span></code></td>
<td>Strongly recommended</td>
<td>Fortran compiler</td>
<td><code class="docutils literal notranslate"><span class="pre">FC=mpif90</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">FCFLAGS=&quot;&lt;Fortran</span> <span class="pre">compiler</span> <span class="pre">flags&gt;&quot;</span></code></td>
<td>Optional, recommended</td>
<td>Fortran compiler flags</td>
<td><code class="docutils literal notranslate"><span class="pre">FCFLAGS=&quot;-O3&quot;</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">CC=&lt;C</span> <span class="pre">compiler&gt;</span></code></td>
<td>Strongly Recommended</td>
<td>C compiler</td>
<td><code class="docutils literal notranslate"><span class="pre">CC=mpicc</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">CFLAGS=&quot;&lt;C</span> <span class="pre">compiler</span> <span class="pre">flags&gt;&quot;</span></code></td>
<td>Optional, recommended</td>
<td>C compiler flags</td>
<td><code class="docutils literal notranslate"><span class="pre">CFLAGS=&quot;-O3&quot;</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">LDFLAGS=&quot;&lt;linker</span> <span class="pre">flags&gt;&quot;</span></code></td>
<td>Optional</td>
<td>Linker flags</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
<p>More information on how to customize the <code class="docutils literal notranslate"><span class="pre">configure</span></code> script can be found by calling:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ./configure --help
</pre></div>
</div>
<p>For a up-to-date list of configure commands for various platforms please refer to <a class="reference internal" href="install_p3dfft.html#installing-p3dfft"><span class="std std-ref">Installing P3DFFT</span></a> page.</p>
<p>After you have successfully run the <code class="docutils literal notranslate"><span class="pre">configure</span></code> script, you are ready to compile and install P3DFFT. Simply run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ make
$ make install
</pre></div>
</div>
</div>
<div class="section" id="p3dfft-module">
<h2>3. p3dfft module<a class="headerlink" href="#p3dfft-module" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">p3dfft</span></code> module declares important variables. It should be included in any code that calls <code class="docutils literal notranslate"><span class="pre">p3dfft</span></code> routines (via using <code class="docutils literal notranslate"><span class="pre">p3dfft</span></code> statement in Fortran).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">p3dfft</span></code> module also specifies <code class="docutils literal notranslate"><span class="pre">mytype</span></code>, which is the type of real and complex numbers. You can choose precision at compile time through a preprocessor flag (see <a class="reference internal" href="install_p3dfft.html#installing-p3dfft"><span class="std std-ref">Installing P3DFFT</span></a> page).</p>
</div>
<div class="section" id="initialization">
<h2>4. Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h2>
<p>Before using the library it is necessary to call an initialization routine <code class="docutils literal notranslate"><span class="pre">p3dfft_setup</span></code>.</p>
<p><strong>Usage</strong>:</p>
<div class="highlight-guess notranslate"><div class="highlight"><pre><span></span><span class="n">p3dfft_setup</span><span class="p">(</span><span class="n">proc_dims</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">,</span> <span class="n">mpi_comm_in</span><span class="p">,</span> <span class="n">nx_cut</span><span class="p">,</span> <span class="n">ny_cut</span><span class="p">,</span> <span class="n">nz_cut</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">memsize</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Table 4</strong>: Arguments of <code class="docutils literal notranslate"><span class="pre">p3dfft_setup</span></code></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">Argument</th>
<th class="head">Intent</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><em>proc_dims</em></td>
<td>Input</td>
<td>An array of two integers, specifying how the processor grid should be decomposed. Either 1D or 2D decomposition can be specified. For example, when running on 12 processors, (4,3) or (2,6) can be specified as proc_dims to indicate a 2D decomposition, or (1,12) can be specified for 1D decomposition. <em>proc_dims</em> values are used to initialize P1 and P2.</td>
</tr>
<tr class="row-odd"><td><em>nx</em>, <em>ny</em>, <em>nz</em></td>
<td>Input</td>
<td>(Integer) Dimensions of the 3D transform (also the global grid dimensions)</td>
</tr>
<tr class="row-even"><td><em>mpi_comm_in</em></td>
<td>Input</td>
<td>(Integer) MPI Communicator containing all MPI tasks that participate in the partition (in most cases this will be <code class="docutils literal notranslate"><span class="pre">MPI_COMM_WORLD</span></code>).</td>
</tr>
<tr class="row-odd"><td><em>nx_cut</em>, <em>ny_cut</em>, <em>nz_cut</em></td>
<td>Input (optional)</td>
<td>(Integer) Pruned dimensions on output/input (default is same as <em>nx</em>, <em>ny</em>, <em>nz</em>)</td>
</tr>
<tr class="row-even"><td><em>overwrite</em></td>
<td>Input (optional)</td>
<td>(Logical) When set to <code class="docutils literal notranslate"><span class="pre">true</span></code>. (or <code class="docutils literal notranslate"><span class="pre">1</span></code> in C) this argument indicates that it is safe to overwrite the input of the btran (backward transform) routine. This may speed up performance of FFTW routines in some cases when non-stride-1 transforms are made.</td>
</tr>
<tr class="row-odd"><td><em>memsize</em></td>
<td>Output (optional)</td>
<td>Optional argument (array of 3 integers). Memsize can be used to allocate arrays. It contains the dimensions of real-space array that are large enough to contain both input and output of an in-place 3D FFT real-to-complex transform defined by <em>nx</em>, <em>ny</em>, <em>nz</em>, <em>nx_cut</em>, <em>ny_cut</em>, <em>nz_cut</em>.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="array-decomposition">
<h2>5. Array Decomposition<a class="headerlink" href="#array-decomposition" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">p3dfft_setup</span></code> routine sets up the two-dimensional (2D) array decomposition. P3DFFT employs 2D block decomposition whereby processors are arranged into a 2D grid P1 x P2, based on their MPI rank. Two of the dimensions of the 3D grid are block-distributed across the processor grid, by assigning the blocks to tasks in the rank order. The third dimension of the grid remains undivided, i.e. contained entirely within local memory (see Fig. 1). This scheme is sometimes called pencils decomposition.</p>
<p>A block decomposition is defined by dimensions of the local portion of the array contained within each task, as well as the beginning and ending indices for each dimension defining the array’s location within the global array. This information is returned by <code class="docutils literal notranslate"><span class="pre">p3dfft_get_dims</span></code> routine which should be called before setting up the data structures of your program (see <code class="docutils literal notranslate"><span class="pre">sample/</span></code> subdirectory for example programs).</p>
<p>In P3DFFT, the decompositions of the output and input arrays, while both being two-dimensional, differ from each other. The reason for this is as follows. In 3D Fourier Transform it is necessary to transpose the data a few times (two times for two-dimensional decomposition) in order to rearrange the data so as to always perform one-dimensional FFT on data local in memory of each processing element. It would be possible to transpose the data back to the original form after the 3D transform is done, however it often makes sense to save significant time by forgoing this final transpose. All the user has to do is to operate on the output array while keeping in mind that the data are in a transposed form. The backward (complex-to-real) transform takes the array in a transposed form and produces a real array in the original form. The rest of this section clarifies exactly the original and transposed form of the arrays.</p>
<p>Starting with v. 2.7.5 P3DFFT features optional hybrid MPI/OpenMP implementation. In this case the MPI decomposition is the same as above, and each MPI task now has Nthr threads. This essentially implements 3D decomposition, however the results are global arrays (in the OpenMP sense) so they can be used either with multi- or single-threaded program. The number of threads is specified through the environment variable <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code>.</p>
<p><strong>Usage</strong>:</p>
<div class="highlight-guess notranslate"><div class="highlight"><pre><span></span><span class="nv">p3dfft_get_dims</span><span class="ss">(</span><span class="nv">start</span>,<span class="k">end</span>,<span class="nv">size</span>,<span class="nv">ip</span><span class="ss">)</span>
</pre></div>
</div>
<p><strong>Table 5</strong>: Arguments of <code class="docutils literal notranslate"><span class="pre">p3dfft_get_dims()</span></code></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr class="row-odd"><th class="head">Argument</th>
<th class="head">Intent</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><em>start</em></td>
<td>Output</td>
<td>An array containing 3 integers, defining the beginning indices of the local array for the given task within the global grid.</td>
</tr>
<tr class="row-odd"><td><em>end</em></td>
<td>Output</td>
<td>An array containing 3 integers, defining the ending indices of the local array within the global grid (these can be computed from <em>start</em> and <em>size</em> but are provided for convenience).</td>
</tr>
<tr class="row-even"><td><em>size</em></td>
<td>Output</td>
<td>An array containing 3 integers, defining the local array’s dimensions.</td>
</tr>
<tr class="row-odd"><td><em>mypad</em></td>
<td>Output/Optional</td>
<td>This argument is optional and is used in in-place transforms, to obtain the value of padding that should be used in the third dimension of the input array (since input and output arrays may not have the same memory size)</td>
</tr>
<tr class="row-even"><td><em>ip</em></td>
<td>Input</td>
<td><code class="docutils literal notranslate"><span class="pre">ip=1</span></code>: &quot;Original&quot;: a &quot;physical space&quot; array of real numbers, local in X, distributed among P1 tasks in Y dimension and P2 tasks in Z dimension, where P1 and P2 are processor grid dimensions defined in the call to p3dfft_setup. Usually this type of array is an input to real-to-complex (forward) transform and an output of complex-to-real (backward) transform. <code class="docutils literal notranslate"><span class="pre">ip=2</span></code>: &quot;Transposed&quot;: a &quot;wavenumber space&quot; array of complex numbers, local in Z, distributed among P1 tasks in X dimension, P2 tasks in Y dimension. Usually this type of array is an output of real-to- complex (forward) transform and an input to complex-to-real, backward transform. <code class="docutils literal notranslate"><span class="pre">ip=3</span></code>: the routine returns three numbers corresponding to &quot;padded&quot; dimensions in the physical space, i.e. an array with these dimensions will be large enough both for physical and wavenumber space. Example of use of this feature can be found in <code class="docutils literal notranslate"><span class="pre">driver_sine_inplace.F90</span></code> sample program.</td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The layout of the 2D processor grid on the physical network is dependent on the architecture and software of the particular system, and can have some impact on efficiency of communication. By default, rows have processors with adjacent task IDs (this corresponds to &quot;FORTRAN&quot; type ordering). This can be changed to &quot;C&quot; ordering (columns have adjacent task IDs) by building the library with <code class="docutils literal notranslate"><span class="pre">-DDIMS_C</span></code> preprocessor flag. The former way is recommended on most systems.</p>
</div>
<p>P3DFFT uses 2D block decomposition to assign local arrays for each task. In many cases decomposition will not be entirely even: some tasks will get more array elements than others. P3DFFT attempts to minimize load imbalance. For example, the grid dimensions are 128x256x256 and the processor grid is defined as 3x4, the original (<code class="docutils literal notranslate"><span class="pre">ip=1</span></code>) decomposition calls for splitting 256 elements in Y dimension into three processor row. In this case, P3DFFT will break it up into pieces of 86, 85 and 85 elements. The transposed (<code class="docutils literal notranslate"><span class="pre">ip=2</span></code>) decomposition will have local arrays with X dimensions 22, 22 and 21 respectively for processor rows 1 through 3 (the sum of these numbers is 65=(nx+2)/2 since these are now complex numbers instead of reals, and an extra mode for Nyquist frequency is needed – see Section 5 for an explanation).</p>
<p>It should be clear that the user’s choice of P1 and P2 can make a difference on how balanced is the decomposition. Obviously the greater load imbalance, the less performance can be expected.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The two array types are distributed among processors in a different way from each other, but this does not automatically imply anything about the ordering of the elements in memory. Memory layout of the original (<code class="docutils literal notranslate"><span class="pre">ip=1</span></code>) array uses the &quot;Fortran&quot; ordering. For example, for an array A(lx,ly,lz) the index corresponding to lx runs fastest. Memory layout for the transposed (<code class="docutils literal notranslate"><span class="pre">ip=2</span></code>) array type depends on how the P3DFFT library was built. By default, it preserves the ordering of the real array, i.e. (X,Y,Z). However, in many cases it is advisable to have Z dimension contiguous, i.e. a memory layout (Z,Y,X). This can speed up some computations in the wavenumber space by improving cache utilization through spatial locality in Z, and also often results in better performance of P3DFFT transforms themselves. The (Z,Y,X) layout can be triggered by building the library with <code class="docutils literal notranslate"><span class="pre">–DSTRIDE1</span></code> preprocessor flag in the makefile. For more information, see performance section below.</p>
</div>
<p><strong>Table 6</strong>. Mapping of the data array onto processor grid and memory layout</p>
<table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">&#160;</th>
<th class="head">Physical space</th>
<th class="head">Fourier space</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">STRIDE1</span></code> defined</td>
<td>Nx, Ny/M1, Nz/M2</td>
<td>Nz, Ny/M2, (Nx+2)/(2M1)</td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">STRIDE1</span></code> undefined</td>
<td>Nx, Ny/M1, Nz /M2</td>
<td>(Nx+2)/(2M1), Ny/M2 ,Nz</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="forward-real-to-complex-and-backward-complex-to-real-3d-fourier-transforms">
<h2>6. Forward (real-to-complex) and backward (complex-to-real) 3D Fourier transforms<a class="headerlink" href="#forward-real-to-complex-and-backward-complex-to-real-3d-fourier-transforms" title="Permalink to this headline">¶</a></h2>
<p>P3DFFT versions 2.7.1 and higher implement transforms for one or more than one independent arrays/variables simultaneously. An example of this is 3 components of a velocity field. Multivariable transforms achieve greater speed than single-variable transforms, especially for grids of smaller size, due to buffer aggregation in inter-processor exchanges.</p>
<p>Forward transform is implemented by the <code class="docutils literal notranslate"><span class="pre">p3dfft_ftran_r2c</span></code> subroutine using the following format:</p>
<div class="highlight-guess notranslate"><div class="highlight"><pre><span></span><span class="n">p3dfft_ftran_r2c</span><span class="p">(</span><span class="k">IN</span><span class="p">,</span><span class="k">OUT</span><span class="p">,</span><span class="n">op</span><span class="p">)</span>
</pre></div>
</div>
<p>The input <strong>IN</strong> is an array of real numbers with dimensions defined by array type with <code class="docutils literal notranslate"><span class="pre">ip=1</span></code> (see Table 2 above), with X dimension contained entirely within each task, and Y and Z dimensions distributed among P1 and P2 tasks correspondingly. The output <strong>OUT</strong> is an array of complex numbers with dimensions defined by array type with <code class="docutils literal notranslate"><span class="pre">ip=2</span></code>, i.e. Z dimension contained entirely, and X and Y dimensions distributed among P1 and P2 tasks respectively. The <strong>op</strong> argument is a 3- letter character string indicating the type of transform desired. Currently only Fourier transforms are supported in X and Y (denoted by symbol <em>f</em>) and the following transforms in Z:</p>
<p><strong>Table 7</strong>. Suuported types of transforms in Z</p>
<table border="1" class="colwidths-auto docutils">
<tbody valign="top">
<tr class="row-odd"><td><em>t</em> or <em>f</em></td>
<td>Fourier Transform</td>
</tr>
<tr class="row-even"><td><em>c</em></td>
<td>Cosine Transform</td>
</tr>
<tr class="row-odd"><td><em>s</em></td>
<td>Sine Transform</td>
</tr>
<tr class="row-even"><td><em>n</em> or <em>0</em></td>
<td>Empty transform (no operation takes place, output is the same as input)</td>
</tr>
</tbody>
</table>
<p>Empty transform can be useful for someone implementing custom transform in Z dimension. Example: <code class="docutils literal notranslate"><span class="pre">op='ffc'</span></code> means Fourier transform in X and Y, and a cosine transform in Z. The DCT-I kind of transform is performed (DST-I for sine), the definition of which can be found <a class="reference external" href="http://en.wikipedia.org/wiki/Discrete_cosine_transform#DCT-I">here</a>.</p>
<p>Backward transform is implemented by the <code class="docutils literal notranslate"><span class="pre">p3dfft_btran_c2r</span></code> subroutine using the following format:</p>
<div class="highlight-guess notranslate"><div class="highlight"><pre><span></span><span class="n">p3dfft_btran_c2r</span><span class="p">(</span><span class="k">IN</span><span class="p">,</span><span class="k">OUT</span><span class="p">,</span><span class="n">op</span><span class="p">)</span>
</pre></div>
</div>
<p>The input <strong>IN</strong> is an array of complex numbers with dimensions defined by array type with <code class="docutils literal notranslate"><span class="pre">ip=2</span></code> (see Table 2 above), i.e. Z dimension is contained entirely, and X and Y dimensions are distributed among P1 and P2 tasks correspondingly. The output <strong>OUT</strong> is an array of real numbers with dimensions defined by array type with <code class="docutils literal notranslate"><span class="pre">ip=1</span></code>, i.e. X dimension is contained entirely within each task, and Y and Z are dimensions distributed among P1 and P2 tasks respectively. The <strong>op</strong> argument is similar to forward transform, with the first character of the string being one of <em>t</em>, <em>c</em>, <em>s</em>, <em>n</em>, or <em>0</em>, and the second and third being <em>f</em>. Example: <code class="docutils literal notranslate"><span class="pre">op='nff'</span></code> means no operation in Z, backward Fourier transforms in Y and X.</p>
</div>
<div class="section" id="complex-array-storage-definition">
<h2>7. Complex array storage definition<a class="headerlink" href="#complex-array-storage-definition" title="Permalink to this headline">¶</a></h2>
<p>Since Fourier transform of a real function has the property of conjugate symmetry, only about half of the complex Fourier coefficients need to be kept. To be precise, if the input array has n real elements, Fourier coefficients F(k) for k=n/2+1,..,n can be dropped as they can be easily restored from the rest of the coefficients. This saves both memory and time. In this version we do not attempt to further pack the complex data. Therefore the output array for the forward transform (and the input array of the backward transform) contains (<em>nx</em>/2+1) times <em>ny</em> times <em>nz</em> complex numbers, with the understanding that <em>nx</em>/2-1 elements in X direction are missing and can be restored from the remaining elements. As mentioned above, the <em>nx</em>/2+1 elements in the X direction are distributed among P1 tasks in the transposed layout.</p>
</div>
<div class="section" id="multivariable-transforms">
<h2>8. Multivariable transforms<a class="headerlink" href="#multivariable-transforms" title="Permalink to this headline">¶</a></h2>
<p>Sometime communication performance of transposes such as those included in P3DFFT can be improved by combining several transforms into a single operation. (This allows us to aggregate messages during interprocessor data exchange). This is especially important when transforming small grids and/or when using systems with high interconnect latencies. P3DFFT provides multivariable transforms to make use of this idea. Instead of an 3D array as input parameter these subroutines accept a 4D array, with the extra dimension being the index of independent variables to be transformed (for example this could be 3 velocity components). The following is the syntax for multivariable transforms:</p>
<div class="highlight-guess notranslate"><div class="highlight"><pre><span></span><span class="n">p3dfft_ftran_many_r2c</span><span class="p">(</span><span class="k">IN</span><span class="p">,</span><span class="n">dim_in</span><span class="p">,</span><span class="k">OUT</span><span class="p">,</span><span class="n">dim_out</span><span class="p">,</span><span class="n">nv</span><span class="p">,</span><span class="n">op</span><span class="p">)</span>

<span class="n">p3dfft_btran_many_c2r</span><span class="p">(</span><span class="k">IN</span><span class="p">,</span><span class="n">dim_in</span><span class="p">,</span><span class="k">OUT</span><span class="p">,</span><span class="n">dim_out</span><span class="p">,</span><span class="n">nv</span><span class="p">,</span><span class="n">op</span><span class="p">)</span>
</pre></div>
</div>
<p>The multivariable transform routines for both forward and backward transforms have an additional argument <strong>nv</strong> (integer) representing the number of independent variables in the input/output arrays. The spacing between these independent variables is defined by <strong>dim_in</strong> and <strong>dim_out</strong> (integer) arguments for input/output arrays respectively. Both <strong>dim_in</strong> and <strong>dim_out</strong> should not be less than the size of the grid returned by <code class="docutils literal notranslate"><span class="pre">get_dims</span></code> routine. See sample program <code class="docutils literal notranslate"><span class="pre">driver_sine_many.F90</span></code>, <code class="docutils literal notranslate"><span class="pre">driver_sine_inplace_many.F90</span></code>, or <code class="docutils literal notranslate"><span class="pre">driver_rand_many.F90</span></code> for an example of such use.</p>
</div>
<div class="section" id="pruned-transforms">
<h2>9. Pruned transforms<a class="headerlink" href="#pruned-transforms" title="Permalink to this headline">¶</a></h2>
<p>Sometimes only a subset of output modes is needed to be retained (for forward transform), or a subset of input modes is used, the rest being zeros (for backward transform). Such transforms are called pruned transforms. Leaving off redundant modes can lead to significant savings of time and memory. The reduced dimensions <strong>nx_cut</strong>, <strong>ny_cut</strong>, and <strong>nz_cut</strong> are arguments to <code class="docutils literal notranslate"><span class="pre">p3dfft_setup</span></code>. By default they are equal to <code class="docutils literal notranslate"><span class="pre">nx</span></code>, <code class="docutils literal notranslate"><span class="pre">ny</span></code>, <code class="docutils literal notranslate"><span class="pre">nz</span></code>. If they are different from the above (smaller) the output of forward transforms will be reduced in size correspondingly. The input for backward transform will also be smaller in size. It will be automatically padded with zeros until it reaches <em>nx</em>, <em>ny</em>, <em>nz</em>.</p>
</div>
<div class="section" id="in-place-transforms">
<h2>10. In-place transforms<a class="headerlink" href="#in-place-transforms" title="Permalink to this headline">¶</a></h2>
<p>In and Out arrays can occupy the same space in memory (in-place transform). In this case, it is necessary to make sure that they start in the same location, otherwise the results are unpredictable. Also it is important to remember that the sizes of input and output arrays in general are not equal. The complex array is usually bigger since it contains the Nyquist frequency mode in X direction, in addition to the <em>nx</em>/2 modes that equal in space to <em>nx</em> real numbers. However when decomposition is not even, sometimes the real array can be bigger than the complex one, depending on the task ID. Therefore to be safe one must make sure the common-space array is large enough for both input and output. This can be done by using memsize argument when calling <code class="docutils literal notranslate"><span class="pre">p3dfft_setup</span></code>. It returns the maximum array size for both input and output. Alternatively, one can call <code class="docutils literal notranslate"><span class="pre">p3dfft_get_dims</span></code> two times with <code class="docutils literal notranslate"><span class="pre">ip=1</span></code> and <code class="docutils literal notranslate"><span class="pre">ip=2</span></code>.</p>
<p>In Fortran using in-place transforms is a bit tricky due to language restrictions on subroutine argument types (i.e., one of the arrays is expected to be real and the other complex). In order to overcome this problem wrapper routines are provided, named <code class="docutils literal notranslate"><span class="pre">ftran_r2c</span></code> and <code class="docutils literal notranslate"><span class="pre">btran_c2r</span></code> respectively for forward and backward transform (without <code class="docutils literal notranslate"><span class="pre">p3dfft</span></code> prefix). There are examples for such in-place transform in the <code class="docutils literal notranslate"><span class="pre">sample/</span></code> subdirectory. These wrappers can be also used for out-of-place transforms just as well.</p>
</div>
<div class="section" id="memory-requirements">
<h2>11. Memory requirements<a class="headerlink" href="#memory-requirements" title="Permalink to this headline">¶</a></h2>
<p>Besides the input and output arrays (which can occupy the same space, as mentioned above) P3DFFT allocates temporary buffers roughly 3 times the size of the input or output array.</p>
</div>
<div class="section" id="performance-considerations">
<h2>12. Performance considerations<a class="headerlink" href="#performance-considerations" title="Permalink to this headline">¶</a></h2>
<p>P3DFFT was created to compute 3D FFT in parallel with high efficiency. In particular it is aimed for applications where the data volume is large. It is especially useful when running applications on ultra-scale parallel platforms where one-dimensional decomposition is not adequate. Since P3DFFT was designed to be portable, no effort is made to do architecture-specific optimization. However, the user is given some choices in setting up the library, mentioned below, that may affect performance on a given system. Current version of P3DFFT uses ESSL or FFTW library for it 1D FFT routines. ESSL [1] provides FFT routines highly optimized for IBM platforms it is built on. The FFTW [2], while being generic, also makes an effort to maximize performance on many kinds of architectures. Some performance data will be uploaded at the P3DFFT Web site. For more questions and comments please contact <a class="reference external" href="mailto:dmitry&#37;&#52;&#48;sdsc&#46;edu">dmitry<span>&#64;</span>sdsc<span>&#46;</span>edu</a>.</p>
<p>Optimal performance on many parallel platforms for a given number of cores and problem size will likely depend on the choice of processor decomposition. For example, given a processor grid P1 x P2 (specified in the first argument to <code class="docutils literal notranslate"><span class="pre">p3dfft_setup</span></code>) performance will generally be better with smaller P1 (with the product P1 x P2 kept constant). Ideally P1 will be equal or less than the number of cores on an SMP node or a multi-core chip. In addition, the closer a decomposition is to being even, the better load balancing.</p>
<p>Beginning with v.2.7.5 P3DFFT is equipped with MPI/OpenMP capability. If use of this feature is needed simply set the desired number of threads through environment variable <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code>. The optimal number of threads, just like the processor grid, depends on specific platform and problem.</p>
<p>Performance is likely to be better when P3DFFT is built using <code class="docutils literal notranslate"><span class="pre">--enable-stride1</span></code> during configure. This implies stride-1 data ordering for FFTs. Note that using this argument changes the memory layout of the transposed array (see section 3 for explanation). To help tune performance further, two more arguments can be used: <code class="docutils literal notranslate"><span class="pre">--enable-dnblx=…</span></code> and <code class="docutils literal notranslate"><span class="pre">--enable-dnbly=…</span></code>, which define block sizes in X and Y when doing local array reordering. Choosing suitable block sizes allows the program to optimize cache performance, although by default P3DFFT chooses these values based on a good guess according to cache size.</p>
<p>Finally, performance will be better if overwrite parameter is set to <code class="docutils literal notranslate"><span class="pre">true</span></code>. (or <code class="docutils literal notranslate"><span class="pre">1</span></code> in C) when initializing P3DFFT. This allows the library to overwrite the input array, which results in significantly faster execution when not using the <code class="docutils literal notranslate"><span class="pre">--enable-stride1</span></code> argument.</p>
</div>
<div class="section" id="references">
<h2>13. References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>ESSL library, IBM, <a class="reference external" href="http://publib.boulder.ibm.com/infocenter/clresctr/vxrx/index.jsp?topic=/com.ibm.cluster.essl.doc/esslbooks.html">http://publib.boulder.ibm.com/infocenter/clresctr/vxrx/index.jsp?topic=/com.ibm.cluster.essl.doc/esslbooks.html</a></li>
<li>Matteo Frigo and Steven G. Johnson, &quot;The Design and Implementation of FFTW3&quot;, Proceedings of the IEEE 93 (2), 216–231 (2005). Invited paper, Special Issue on Program Generation, Optimization, and Platform Adaptation.</li>
<li>D. Pekurovsky, “P3DFFT: a framework for parallel computations of Fourier transforms in three dimensions”, SIAM Journal on Scientific Computing 2012, Vol. 34, No. 4, pp. C192-C209.</li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="install_p3dfft++.html" class="btn btn-neutral float-right" title="Installing P3DFFT++" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="download_p3dfft.html" class="btn btn-neutral float-left" title="Download P3DFFT" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Dmitry Pekurovsky

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>